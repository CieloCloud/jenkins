pipeline {
    agent any

    environment {
        // adjust if your Jenkins home is different
        MAVEN_CACHE = "${env.HOME}/.m2"
        SONAR_TOKEN = credentials('SONAR_TOKEN')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'ls -ltr'
            }
        }

      stage('Build and Push Docker Image') {
    environment {
        DOCKER_IMAGE = "cielocloud/jenkins:${BUILD_NUMBER}"
    }
    steps {
        withCredentials([usernamePassword(
            credentialsId: 'docker-cred',
            usernameVariable: 'DOCKER_USERNAME',
            passwordVariable: 'DOCKER_PASSWORD'
        )]) {
            script {
                sh '''
                  echo "Logging in to Docker Hub"
                  echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

                  echo "Building Docker image"
                  cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
                  docker build -t ${DOCKER_IMAGE} .

                  echo "Pushing Docker image"
                  docker push ${DOCKER_IMAGE}

                  echo "Docker images on Jenkins node:"
                  docker images | grep ultimate-cicd || true
                '''
            }
        }
    }
}


stage('SonarQube Analysis') {
    agent {
        docker {
            image 'maven:3.9.6-eclipse-temurin-17'
            args "--network=host -v ${MAVEN_CACHE}:/root/.m2"
        }
    }
    environment {
        SONAR_USER_HOME = "${WORKSPACE}/.sonar"
    }
    steps {
        dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
            sh '''
              mkdir -p ${SONAR_USER_HOME}
              mvn org.sonarsource.scanner.maven:sonar-maven-plugin:5.5.0.6356:sonar \
                -Dsonar.projectKey=spring-boot-demo \
                -Dsonar.projectName=spring-boot-demo \
                -Dsonar.host.url=http://localhost:9000
            '''
        }
    }
}



        stage('Docker Build') {
            when { expression { return false } } // enable when you add Dockerfile
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    sh '''
                      docker build -t yourrepo/spring-boot-demo:${BUILD_NUMBER} .
                    '''
                }
            }
        }

        stage('Deploy (Helm/ArgoCD)') {
            when { expression { return false } } // enable later
            steps {
                echo 'Deploy stage placeholder'
            }
        }
    }
}
