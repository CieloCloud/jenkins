pipeline {
    agent any

    environment {
        // adjust if your Jenkins home is different
        MAVEN_CACHE = "${env.HOME}/.m2"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh 'ls -ltr'
            }
        }

        stage('Build and Test') {
            agent {
                docker {
                    image 'maven:3.8.6-openjdk-8'
                    // share docker socket (for later stages) and Maven cache
                    args "-v /var/run/docker.sock:/var/run/docker.sock -v ${MAVEN_CACHE}:/root/.m2"
                }
            }
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    sh '''
                      mvn clean package -U -T 1C \
                        --batch-mode \
                        --no-transfer-progress
                    '''
                }
            }
        }

        stage('SonarQube') {
            when { expression { return false } } // enable when ready
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    sh '''
                      mvn sonar:sonar \
                        -Dsonar.projectKey=spring-boot-demo \
                        -Dsonar.host.url=http://host.docker.internal:9000 \
                        -Dsonar.login=${SONAR_TOKEN}
                    '''
                }
            }
        }

        stage('Docker Build') {
            when { expression { return false } } // enable when you add Dockerfile
            steps {
                dir('java-maven-sonar-argocd-helm-k8s/spring-boot-app') {
                    sh '''
                      docker build -t yourrepo/spring-boot-demo:${BUILD_NUMBER} .
                    '''
                }
            }
        }

        stage('Deploy (Helm/ArgoCD)') {
            when { expression { return false } } // enable later
            steps {
                echo 'Deploy stage placeholder'
            }
        }
    }
}
